{% extends "finance/base.html" %}

{% block title %}Recurring Transactions{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Recurring Transactions</h1>
        <a href="{% url 'finance:recurring_create' %}" class="btn btn-primary">+ New Recurring</a>
    </div>

    <div style="display: flex; gap: 20px; margin-bottom: 30px;">
        <div style="flex: 1; padding: 20px; background-color: #e3f2fd; border-radius: 8px; text-align: center;">
            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Active Templates</div>
            <div style="font-size: 28px; font-weight: bold; color: #2980b9;">{{ active_count }}</div>
        </div>
        <div style="flex: 1; padding: 20px; background-color: #fff3e0; border-radius: 8px; text-align: center;">
            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Monthly Total</div>
            <div style="font-size: 28px; font-weight: bold; color: #f39c12;">${{ total_monthly|floatformat:2 }}</div>
        </div>
        <div style="flex: 1; padding: 20px; background-color: #e8f5e9; border-radius: 8px; text-align: center;">
            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Est. Monthly Cost</div>
            <div style="font-size: 28px; font-weight: bold; color: #27ae60;">${{ estimated_monthly|floatformat:2 }}</div>
            <div style="font-size: 12px; color: #888;">All frequencies combined</div>
        </div>
    </div>

    {% if active_recurring %}
    <h2 style="margin-bottom: 15px;">Active</h2>
    <table>
        <thead>
            <tr>
                <th>Vendor</th>
                <th>Description</th>
                <th>Account</th>
                <th>Category</th>
                <th style="text-align: right;">Amount</th>
                <th>Frequency</th>
                <th>Next Due</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for r in active_recurring %}
            <tr>
                <td>
                    <a href="{% url 'finance:recurring_detail' r.id %}" style="font-weight: 500;">
                        {{ r.vendor }}
                    </a>
                </td>
                <td>{{ r.description|truncatechars:40 }}</td>
                <td>{{ r.account.name }}</td>
                <td>{{ r.category.name }}</td>
                <td style="text-align: right;">${{ r.amount|floatformat:2 }}</td>
                <td>
                    <span class="badge" style="background-color:
                        {% if r.frequency == 'monthly' %}#3498db
                        {% elif r.frequency == 'quarterly' %}#9b59b6
                        {% else %}#27ae60{% endif %}; color: white;">
                        {{ r.get_frequency_display }}
                    </span>
                </td>
                <td>{{ r.next_due|date:"M d, Y" }}</td>
                <td>
                    <a href="{% url 'finance:recurring_detail' r.id %}" class="btn btn-secondary" style="padding: 3px 8px; font-size: 11px;">View</a>
                    <a href="{% url 'finance:recurring_edit' r.id %}" class="btn btn-secondary" style="padding: 3px 8px; font-size: 11px;">Edit</a>
                    <form action="{% url 'finance:recurring_toggle_active' r.id %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-secondary" style="padding: 3px 8px; font-size: 11px;">Deactivate</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No active recurring transactions. Click "New Recurring" to add one.</p>
    {% endif %}

    {% if inactive_recurring %}
    <h2 style="margin: 30px 0 15px 0;">Inactive</h2>
    <table>
        <thead>
            <tr>
                <th>Vendor</th>
                <th>Description</th>
                <th>Account</th>
                <th style="text-align: right;">Amount</th>
                <th>Frequency</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for r in inactive_recurring %}
            <tr style="opacity: 0.6;">
                <td>
                    <a href="{% url 'finance:recurring_detail' r.id %}" style="font-weight: 500;">
                        {{ r.vendor }}
                    </a>
                </td>
                <td>{{ r.description|truncatechars:40 }}</td>
                <td>{{ r.account.name }}</td>
                <td style="text-align: right;">${{ r.amount|floatformat:2 }}</td>
                <td>{{ r.get_frequency_display }}</td>
                <td>
                    <a href="{% url 'finance:recurring_detail' r.id %}" class="btn btn-secondary" style="padding: 3px 8px; font-size: 11px;">View</a>
                    <form action="{% url 'finance:recurring_toggle_active' r.id %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success" style="padding: 3px 8px; font-size: 11px;">Activate</button>
                    </form>
                    <form action="{% url 'finance:recurring_delete' r.id %}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this recurring transaction? Generated transactions will not be deleted.');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" style="padding: 3px 8px; font-size: 11px;">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endblock %}
