{% extends "finance/base.html" %}

{% block title %}Financial Dashboard{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>Financial Dashboard</h1>
    <div>
        <a href="{% url 'finance:transaction_create' %}" class="btn btn-primary">+ New Transaction</a>
    </div>
</div>

<!-- Account Balances Row -->
<div style="display: flex; gap: 20px; margin-bottom: 30px;">
    <div class="card" style="flex: 1; text-align: center; padding: 25px;">
        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Cash Available</div>
        <div style="font-size: 32px; font-weight: bold; color: #27ae60;">${{ total_checking|floatformat:2 }}</div>
        <div style="font-size: 12px; color: #888; margin-top: 5px;">Checking + Savings</div>
    </div>
    <div class="card" style="flex: 1; text-align: center; padding: 25px;">
        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Credit Balance</div>
        <div style="font-size: 32px; font-weight: bold; color: {% if total_credit > 0 %}#e74c3c{% else %}#27ae60{% endif %};">${{ total_credit|floatformat:2 }}</div>
        <div style="font-size: 12px; color: #888; margin-top: 5px;">Amount Owed</div>
    </div>
    <div class="card" style="flex: 1; text-align: center; padding: 25px;">
        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Net Position</div>
        <div style="font-size: 32px; font-weight: bold; color: {% if net_position >= 0 %}#27ae60{% else %}#e74c3c{% endif %};">${{ net_position|floatformat:2 }}</div>
        <div style="font-size: 12px; color: #888; margin-top: 5px;">Cash - Credit</div>
    </div>
</div>

<!-- Month-to-Date and Quarter-to-Date Row -->
<div style="display: flex; gap: 20px; margin-bottom: 30px;">
    <div class="card" style="flex: 1;">
        <h2 style="margin-bottom: 15px;">Month to Date</h2>
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1; text-align: center; padding: 15px; background-color: #e8f5e9; border-radius: 8px;">
                <div style="font-size: 12px; color: #666;">Income</div>
                <div style="font-size: 24px; font-weight: bold; color: #27ae60;">+${{ mtd_summary.income|floatformat:2 }}</div>
            </div>
            <div style="flex: 1; text-align: center; padding: 15px; background-color: #ffebee; border-radius: 8px;">
                <div style="font-size: 12px; color: #666;">Expenses</div>
                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">-${{ mtd_summary.expenses|floatformat:2 }}</div>
            </div>
            <div style="flex: 1; text-align: center; padding: 15px; background-color: {% if mtd_summary.net_profit >= 0 %}#e3f2fd{% else %}#fff3e0{% endif %}; border-radius: 8px;">
                <div style="font-size: 12px; color: #666;">Net Profit</div>
                <div style="font-size: 24px; font-weight: bold; color: {% if mtd_summary.net_profit >= 0 %}#2980b9{% else %}#e74c3c{% endif %};">
                    {% if mtd_summary.net_profit >= 0 %}+{% endif %}${{ mtd_summary.net_profit|floatformat:2 }}
                </div>
            </div>
        </div>
    </div>
    <div class="card" style="flex: 1;">
        <h2 style="margin-bottom: 15px;">Q{{ current_quarter }} {{ current_year }} to Date</h2>
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1; text-align: center; padding: 15px; background-color: #e8f5e9; border-radius: 8px;">
                <div style="font-size: 12px; color: #666;">Income</div>
                <div style="font-size: 24px; font-weight: bold; color: #27ae60;">+${{ qtd_summary.income|floatformat:2 }}</div>
            </div>
            <div style="flex: 1; text-align: center; padding: 15px; background-color: #ffebee; border-radius: 8px;">
                <div style="font-size: 12px; color: #666;">Expenses</div>
                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">-${{ qtd_summary.expenses|floatformat:2 }}</div>
            </div>
            <div style="flex: 1; text-align: center; padding: 15px; background-color: {% if qtd_summary.net_profit >= 0 %}#e3f2fd{% else %}#fff3e0{% endif %}; border-radius: 8px;">
                <div style="font-size: 12px; color: #666;">Net Profit</div>
                <div style="font-size: 24px; font-weight: bold; color: {% if qtd_summary.net_profit >= 0 %}#2980b9{% else %}#e74c3c{% endif %};">
                    {% if qtd_summary.net_profit >= 0 %}+{% endif %}${{ qtd_summary.net_profit|floatformat:2 }}
                </div>
            </div>
        </div>
    </div>
</div>

{% if tax_alerts %}
<!-- Tax Alerts -->
<div class="card" style="margin-bottom: 30px; background-color: #fff3e0; border-left: 4px solid #f39c12;">
    <h2 style="color: #e67e22; margin-bottom: 15px;">Tax Alerts</h2>
    {% for alert in tax_alerts %}
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #ffecc7;">
        <div>
            <strong>Q{{ alert.quarter }} {{ alert.year }}</strong>
            <span style="color: #666;"> - Net profit exceeded ${{ alert.threshold_amount|floatformat:0 }}</span>
        </div>
        <div>
            <span style="font-weight: bold; color: #e67e22;">${{ alert.actual_net_profit|floatformat:2 }}</span>
        </div>
    </div>
    {% endfor %}
    <div style="margin-top: 15px; font-size: 12px; color: #888;">
        Consider making estimated tax payments to avoid penalties.
    </div>
</div>
{% endif %}

<!-- Charts and Recent Transactions Row -->
<div style="display: flex; gap: 20px; margin-bottom: 30px;">
    <!-- Spending by Category -->
    <div class="card" style="flex: 1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2>Top Spending (MTD)</h2>
            <a href="{% url 'finance:spending_report' %}" style="font-size: 12px;">View Full Report</a>
        </div>
        {% if top_spending %}
        <div id="spending-chart" style="height: 200px; margin-bottom: 15px;">
            <canvas id="spendingChart"></canvas>
        </div>
        <table style="width: 100%;">
            {% for item in top_spending %}
            <tr>
                <td style="padding: 5px 0;">{{ item.category__name }}</td>
                <td style="text-align: right; color: #e74c3c;">${{ item.total|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p class="text-muted">No expenses this month.</p>
        {% endif %}
    </div>

    <!-- Recent Transactions -->
    <div class="card" style="flex: 1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2>Recent Transactions</h2>
            <a href="{% url 'finance:transaction_list' %}" style="font-size: 12px;">View All</a>
        </div>
        {% if recent_transactions %}
        <table style="width: 100%;">
            {% for tx in recent_transactions %}
            <tr>
                <td style="padding: 8px 0; width: 80px;">
                    <span class="text-muted" style="font-size: 12px;">{{ tx.transaction_date|date:"M d" }}</span>
                </td>
                <td style="padding: 8px 0;">
                    <a href="{% url 'finance:transaction_detail' tx.id %}">{{ tx.description|truncatewords:5 }}</a>
                    <br>
                    <small class="text-muted">{{ tx.account.name }}</small>
                </td>
                <td style="padding: 8px 0; text-align: right;">
                    <span style="color: {% if tx.transaction_type == 'income' %}#27ae60{% elif tx.transaction_type == 'expense' %}#e74c3c{% else %}#666{% endif %};">
                        {% if tx.transaction_type == 'income' %}+{% elif tx.transaction_type == 'expense' or tx.transaction_type == 'owners_draw' %}-{% endif %}
                        ${{ tx.amount|floatformat:2 }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p class="text-muted">No transactions yet.</p>
        {% endif %}
    </div>
</div>

<!-- Quick Links -->
<div class="card">
    <h2 style="margin-bottom: 15px;">Quick Links</h2>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <a href="{% url 'finance:account_list' %}" class="btn btn-secondary">Accounts</a>
        <a href="{% url 'finance:category_list' %}" class="btn btn-secondary">Categories</a>
        <a href="{% url 'finance:csv_import_upload' %}" class="btn btn-secondary">Import CSV</a>
        <a href="{% url 'finance:spending_report' %}" class="btn btn-secondary">Spending Report</a>
        <a href="{% url 'finance:income_statement' %}" class="btn btn-secondary">Income Statement</a>
    </div>
</div>

<!-- Chart.js Integration -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
{% if top_spending %}
// Spending by Category Chart
const ctx = document.getElementById('spendingChart').getContext('2d');
new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: [{% for item in top_spending %}'{{ item.category__name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for item in top_spending %}{{ item.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                '#e74c3c',
                '#e67e22',
                '#f1c40f',
                '#3498db',
                '#9b59b6'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
